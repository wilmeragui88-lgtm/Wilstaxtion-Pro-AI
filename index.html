<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxiton Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#0f172a;color:white;overflow:hidden}
#map{height:100vh;width:100vw}

.login{
position:absolute;
top:0;left:0;right:0;bottom:0;
background:#0f172a;
display:flex;
flex-direction:column;
justify-content:center;
padding:30px;
z-index:2000;
}

input{
padding:15px;
margin:10px 0;
border:none;
border-radius:10px;
font-size:16px;
}

button{
padding:15px;
border:none;
border-radius:15px;
font-weight:bold;
font-size:16px;
cursor:pointer;
}

.primary{background:#22c55e;color:white;width:100%}
.logout{
position:absolute;
top:15px;
right:15px;
background:#ef4444;
color:white;
padding:8px 12px;
border-radius:10px;
z-index:1000;
}

.panel{
position:absolute;
bottom:0;
left:0;
right:0;
background:white;
color:black;
padding:20px;
border-radius:25px 25px 0 0;
box-shadow:0 -10px 30px rgba(0,0,0,0.3);
}

.hidden{display:none}
.status{font-weight:bold;margin-bottom:5px}
.distance{color:gray;font-size:14px}
</style>
</head>
<body>

<div id="loginScreen" class="login">
<h2>üöñ TAXITON PRO</h2>
<input type="email" id="email" placeholder="Correo">
<input type="password" id="password" placeholder="Contrase√±a">
<button class="primary" onclick="login()">Entrar</button>
</div>

<button class="logout hidden" id="logoutBtn" onclick="logout()">Salir</button>

<div id="map"></div>

<div class="panel hidden" id="panel">
<div class="status" id="status">Listo</div>
<div class="distance" id="distance"></div>
<button class="primary" onclick="requestTaxi()">Solicitar Taxi</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyCw7WoC5AjqnZ2_vagJs5ZklOZt3b4ZRtg",
authDomain: "taxiton-eba22.firebaseapp.com",
projectId: "taxiton-eba22",
storageBucket: "taxiton-eba22.appspot.com",
messagingSenderId: "1091576841981",
appId: "1:1091576841981:web:1dd7bbefb518580fb76094"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let map;
let userLocation;
let taxiMarkers = {};
let nearestTaxi = null;
let isTaxiMode = false;

// LOGIN
window.login = async ()=>{
try{
await signInWithEmailAndPassword(
auth,
document.getElementById("email").value,
document.getElementById("password").value
);

document.getElementById("loginScreen").classList.add("hidden");
document.getElementById("logoutBtn").classList.remove("hidden");
document.getElementById("panel").classList.remove("hidden");

initMap();

}catch(e){
alert(e.message);
}
};

// LOGOUT
window.logout = async ()=>{
await signOut(auth);
location.reload();
};

// MAPA
function initMap(){
navigator.geolocation.getCurrentPosition(position=>{

userLocation = [
position.coords.latitude,
position.coords.longitude
];

map = L.map("map").setView(userLocation,15);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
.addTo(map);

L.marker(userLocation)
.addTo(map)
.bindPopup("Tu ubicaci√≥n")
.openPopup();

listenTaxis();

// Detectar si es taxi (puedes cambiar esto manualmente)
if(confirm("¬øEntrar como TAXI?")){
isTaxiMode = true;
startTaxiMode();
}

});
}

// MODO TAXI - ENV√çA UBICACI√ìN EN TIEMPO REAL
function startTaxiMode(){

navigator.geolocation.watchPosition(async position=>{

const lat = position.coords.latitude;
const lng = position.coords.longitude;

await setDoc(doc(db,"taxis",auth.currentUser.uid),{
lat: lat,
lng: lng,
updated: Date.now()
});

},
error=>console.log(error),
{enableHighAccuracy:true,maximumAge:0}
);

}

// ESCUCHAR TAXIS EN TIEMPO REAL
function listenTaxis(){

onSnapshot(collection(db,"taxis"),snapshot=>{

nearestTaxi = null;
let minDistance = 999999;

snapshot.docChanges().forEach(change=>{

const data = change.doc.data();
const id = change.doc.id;
const position = [data.lat, data.lng];

if(change.type === "added"){
taxiMarkers[id] = L.marker(position,{
icon: L.icon({
iconUrl:"https://cdn-icons-png.flaticon.com/512/744/744465.png",
iconSize:[35,35]
})
}).addTo(map);
}

if(change.type === "modified"){
taxiMarkers[id].setLatLng(position);
}

if(change.type === "removed"){
map.removeLayer(taxiMarkers[id]);
delete taxiMarkers[id];
}

let dist = getDistance(userLocation, position);
if(dist < minDistance){
minDistance = dist;
nearestTaxi = position;
}

});

if(nearestTaxi){
document.getElementById("distance").innerText =
"Taxi m√°s cercano a " + minDistance.toFixed(2) + " km";
}else{
document.getElementById("distance").innerText =
"No hay taxis disponibles";
}

});

}

// CALCULAR DISTANCIA
function getDistance(a,b){
let R=6371;
let dLat=(b[0]-a[0])*Math.PI/180;
let dLon=(b[1]-a[1])*Math.PI/180;
let lat1=a[0]*Math.PI/180;
let lat2=b[0]*Math.PI/180;

let x=Math.sin(dLat/2)**2+
Math.sin(dLon/2)**2*Math.cos(lat1)*Math.cos(lat2);

let d=2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
return d;
}

// SOLICITAR TAXI
window.requestTaxi=()=>{
if(nearestTaxi){
document.getElementById("status").innerText =
"üöï Taxi asignado y en camino...";
}else{
document.getElementById("status").innerText =
"‚ùå No hay taxis disponibles";
}
};

</script>
</body>
</html>