<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wilstaxtion Pro AI - Intelligence Edition</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2ecc71; --secondary: #3498db; --dark: #070b14;
            --card-bg: #111827; --danger: #e74c3c; --text: #f8fafc; --warning: #f1c40f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--dark); height: 100vh; overflow: hidden; color: var(--text); position: fixed; width: 100%; }

        /* Splash */
        #splash { position: fixed; inset: 0; background: var(--dark); z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader { width: 60px; height: 60px; border: 5px solid #1e293b; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-salir-global { position: fixed; top: 20px; right: 20px; z-index: 15000; background: rgba(231, 76, 60, 0.9); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; }

        /* Auth */
        .full-screen { position: fixed; inset: 0; background: var(--dark); z-index: 9000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        .role-btn { flex: 1; padding: 18px; border: 2px solid #1e293b; border-radius: 15px; cursor: pointer; text-align: center; font-weight: bold; color: white; background: var(--card-bg); }
        .role-btn.active { border-color: var(--primary); background: rgba(46, 204, 113, 0.1); color: var(--primary); }
        input { width: 100%; max-width: 340px; padding: 18px; margin: 8px 0; border-radius: 15px; border: 1px solid #1e293b; background: var(--card-bg); color: white; outline: none; }
        .btn-entrar { width: 100%; max-width: 340px; padding: 18px; background: var(--primary); color: var(--dark); border: none; border-radius: 15px; font-weight: 900; text-transform: uppercase; margin-top: 15px; }

        /* Mapas */
        #mapContainer, #miniMapContainer { flex: 1; position: relative; overflow: hidden; background: #000; }
        #map { height: 100%; width: 100%; }
        #miniMapContainer { perspective: 1000px; }
        #miniMap { 
            height: 250%; width: 250%; position: absolute; top: -75%; left: -75%;
            transform: rotateX(45deg); transition: transform 0.5s; transform-origin: center center;
        }

        .map-controls { position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .btn-map-opt { background: white; border: none; width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #333; }
        .btn-map-opt.active { background: var(--primary); color: white; }

        /* Acordeón Perfil Conductor */
        .accordion { width: 100%; max-width: 340px; background: var(--card-bg); border-radius: 15px; margin-bottom: 15px; overflow: hidden; border: 1px solid #1e293b; }
        .acc-header { padding: 12px; background: #1f2937; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; color: var(--primary); font-size: 14px; }
        .acc-content { padding: 0; height: 0; transition: 0.3s ease-out; overflow: hidden; }
        .acc-content.open { padding: 10px; height: auto; }

        /* UI Paneles */
        .p-panel { height: 45vh; background: var(--card-bg); border-radius: 30px 30px 0 0; margin-top: -30px; position: relative; z-index: 10; padding: 25px; overflow-y: auto; }
        #connectingOverlay { display: none; position: absolute; inset: 0; background: var(--card-bg); z-index: 100; flex-direction: column; align-items: center; justify-content: center; text-align: center; border-radius: 30px 30px 0 0; }
        .status-circle { width: 80px; height: 80px; border-radius: 50%; border: 6px solid #1e293b; font-size: 16px; font-weight: 900; margin: 10px auto; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .status-circle.on { background: var(--primary); color: var(--dark); box-shadow: 0 0 25px var(--primary); }
        .status-circle.off { background: #1e293b; color: #4b5563; }
        .driver-controls { position: absolute; bottom: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 15000; }
        .btn-action { width: 80%; padding: 18px; border-radius: 50px; border: none; font-weight: bold; color: white; text-transform: uppercase; }

        #tripAlert { position: fixed; bottom: 30px; left: 20px; right: 20px; background: white; color: black; padding: 25px; border-radius: 25px; z-index: 16000; display: none; text-align: center; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="splash"><div class="loader"></div><h2 style="margin-top:20px; font-weight: 900;">WILSTAXTION PRO AI</h2></div>

<button id="mainLogoutBtn" class="btn-salir-global" style="display:none;" onclick="quickLogout()">SALIR</button>

<div id="authScreen" class="full-screen">
    <h1 style="color:var(--primary); margin-bottom: 30px;">WILSTAXTION</h1>
    <div style="display:flex; gap:10px; width:100%; max-width:340px; margin-bottom:20px;">
        <div class="role-btn active" id="btnRP" onclick="setRole('pasajero')">PASAJERO</div>
        <div class="role-btn" id="btnRT" onclick="setRole('taxi')">TAXISTA</div>
    </div>
    <div id="loginFields" style="width:100%; display:flex; flex-direction:column; align-items:center;">
        <input type="text" id="p-name" placeholder="Tu Nombre">
    </div>
    <button class="btn-entrar" onclick="handleAuth()">INGRESAR</button>
</div>

<div id="passengerApp" style="display:none; flex-direction:column; height:100vh;">
    <div id="mapContainer">
        <div id="map"></div>
        <div class="map-controls">
            <button class="btn-map-opt" onclick="changeMapStyle('day', 'map')"><i class="fas fa-sun"></i></button>
            <button class="btn-map-opt active" onclick="changeMapStyle('night', 'map')"><i class="fas fa-moon"></i></button>
        </div>
    </div>
    <div class="p-panel">
        <div id="connectingOverlay"><h2>CONECTANDO...</h2></div>
        <h3 id="pStatusTitle" style="color:var(--primary); margin-bottom:15px;"><i class="fas fa-taxi"></i> Taxis Disponibles</h3>
        <div id="taxiList"></div>
    </div>
</div>

<div id="taxiApp" style="display:none; flex-direction:column; height:100vh;">
    <div style="height:40vh; display:flex; flex-direction:column; justify-content:center; align-items:center; padding-top:20px;">
        <div class="accordion">
            <div class="acc-header" onclick="toggleAcc()">PERFIL DEL VEHÍCULO <i class="fas fa-chevron-down"></i></div>
            <div class="acc-content" id="accContent">
                <input type="text" id="d-car-input" placeholder="Modelo del Auto">
                <input type="text" id="d-plate-input" placeholder="Número de Placa">
                <button onclick="saveProfile()" style="width:100%; padding:10px; background:var(--secondary); color:white; border:none; border-radius:10px; margin-top:5px;">ACTUALIZAR</button>
            </div>
        </div>
        <div class="status-circle off" id="statusToggle" onclick="toggleWork()">OFF</div>
        <p id="statusLabel" style="color:var(--primary); font-weight:bold;">SISTEMA VIRTUAL</p>
    </div>
    <div id="miniMapContainer">
        <div id="miniMap"></div>
        <div class="map-controls">
            <button class="btn-map-opt" onclick="changeMapStyle('day', 'miniMap')"><i class="fas fa-sun"></i></button>
            <button class="btn-map-opt active" onclick="changeMapStyle('night', 'miniMap')"><i class="fas fa-moon"></i></button>
        </div>
        <div class="driver-controls" id="driverUI" style="display:none;">
            <button class="btn-action" style="background:var(--primary);" onclick="finishTrip()">FINALIZAR SERVICIO</button>
        </div>
    </div>
</div>

<div id="tripAlert">
    <h2 style="color:#333">¡NUEVA SOLICITUD!</h2>
    <p id="clientName" style="margin:10px 0; font-size:20px; font-weight:bold;"></p>
    <div style="display:flex; gap:10px;">
        <button onclick="respondTrip('aceptado')" style="flex:2; padding:20px; background:var(--primary); color:white; border:none; border-radius:15px; font-weight:bold;">ACEPTAR</button>
        <button onclick="respondTrip('rechazado')" style="flex:1; padding:20px; background:var(--danger); color:white; border:none; border-radius:15px;">X</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, query, where, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCw7WoC5AjqnZ2_vagJs5ZklOZt3b4ZRtg",
        authDomain: "taxiton-eba22.firebaseapp.com",
        projectId: "taxiton-eba22",
        storageBucket: "taxiton-eba22.appspot.com",
        messagingSenderId: "1091576841981",
        appId: "1:1091576841981:web:1dd7bbefb518580fb76094"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    let role = 'pasajero', map, miniMap, userPos, lastPos = null, myMarker, routingControl;
    let loggedUserName = "Wil", inTrip = false, tripNotified = false;
    let currentPLayer, currentTLayer;

    const mapStyles = {
        night: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        day: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
    };

    function hablarIA(texto) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(texto);
        msg.lang = 'es-ES';
        window.speechSynthesis.speak(msg);
    }

    // IA Contextual
    window.getIAAdvice = (r) => {
        const advices = {
            pasajero: [
                "El clima está despejado para un viaje perfecto. Recuerda verificar la placa del vehículo antes de subir.",
                "Se reporta una temperatura agradable. Disfruta tu sistema de bienvenida transporte.",
                "La seguridad es nuestra prioridad. Tu conductor ha sido verificado por el sistema virtual."
            ],
            conductor: [
                "El clima es favorable para conducir. Mantén siempre tu distancia de seguridad.",
                "Tu panel de transporte está optimizado. Recuerda que un conductor descansado es un conductor seguro.",
                "Solicitudes activas en el sistema virtual. El tráfico fluye con normality en tu zona."
            ]
        };
        return advices[r][Math.floor(Math.random() * advices[r].length)];
    };

    window.toggleAcc = () => document.getElementById('accContent').classList.toggle('open');
    
    window.saveProfile = () => {
        const p = { auto: document.getElementById('d-car-input').value, placa: document.getElementById('d-plate-input').value };
        localStorage.setItem('driverProfile', JSON.stringify(p));
        hablarIA("Información del sistema virtual actualizada.");
        window.toggleAcc();
    };

    window.changeMapStyle = (style, target) => {
        const targetMap = target === 'map' ? map : miniMap;
        if(target === 'map') {
            if(currentPLayer) targetMap.removeLayer(currentPLayer);
            currentPLayer = L.tileLayer(mapStyles[style]).addTo(targetMap);
        } else {
            if(currentTLayer) targetMap.removeLayer(currentTLayer);
            currentTLayer = L.tileLayer(mapStyles[style]).addTo(targetMap);
        }
    };

    window.setRole = (r) => {
        role = r;
        document.getElementById('btnRP').classList.toggle('active', r === 'pasajero');
        document.getElementById('btnRT').classList.toggle('active', r === 'taxi');
        document.getElementById('loginFields').innerHTML = r === 'pasajero' ? `<input type="text" id="p-name" placeholder="Tu Nombre">` : `<input type="email" id="t-email" placeholder="Email"><input type="password" id="t-pass" placeholder="Pass">`;
    };

    window.handleAuth = async () => {
        if(role === 'pasajero') {
            localStorage.setItem('pName', document.getElementById('p-name').value);
            await signInAnonymously(auth);
        } else {
            try { 
                await signInWithEmailAndPassword(auth, document.getElementById('t-email').value, document.getElementById('t-pass').value);
                loggedUserName = document.getElementById('t-email').value.split('@')[0].toUpperCase();
            } catch { alert("Acceso denegado"); }
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainLogoutBtn').style.display = 'block';
            if (role === 'pasajero') startPassenger(); else startTaxi();
        }
    });

    function startPassenger() {
        const pName = localStorage.getItem('pName') || "Usuario";
        hablarIA(`¡Bienvenido a Wilstaxtion, ${pName}! Te encuentras en tu sistema de bienvenida transporte. ${getIAAdvice('pasajero')}`);
        
        document.getElementById('passengerApp').style.display = 'flex';
        navigator.geolocation.watchPosition(p => {
            userPos = [p.coords.latitude, p.coords.longitude];
            if(!map) {
                map = L.map('map', {zoomControl: false}).setView(userPos, 17);
                currentPLayer = L.tileLayer(mapStyles.night).addTo(map);
                L.circleMarker(userPos, {radius: 9, color: '#3498db', fillOpacity: 0.8, fillColor: '#fff'}).addTo(map);
            }
        });

        onSnapshot(collection(db, "activos"), snap => {
            const list = document.getElementById('taxiList'); list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                if(t.online) {
                    const card = document.createElement('div');
                    card.style = "background:#1f2937; padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;";
                    card.innerHTML = `<div><b>${t.nombre}</b><br><small>${t.auto || 'Taxi'}</small></div>` +
                                     (!t.busy ? `<button onclick="requestRide('${d.id}', '${t.nombre}')" style="background:var(--primary); padding:10px 20px; border:none; border-radius:10px; font-weight:bold;">PEDIR</button>` : '');
                    list.appendChild(card);
                }
            });
        });
    }

    function startTaxi() {
        hablarIA(`Hola ${loggedUserName}, bienvenido a tu panel de transporte y solicitud en el sistema virtual. ${getIAAdvice('conductor')}`);
        
        document.getElementById('taxiApp').style.display = 'flex';
        miniMap = L.map('miniMap', {zoomControl: false}).setView([0,0], 19);
        currentTLayer = L.tileLayer(mapStyles.night).addTo(miniMap);
        myMarker = L.marker([0,0], {icon: L.divIcon({html: '<i class="fas fa-location-arrow" style="color:var(--primary); font-size:40px; transform:rotate(-45deg);"></i>'})}).addTo(miniMap);
        
        onSnapshot(query(collection(db, "viajes"), where("taxiId", "==", auth.currentUser.uid)), snap => {
            snap.forEach(v => {
                if(v.data().status === 'pendiente') {
                    window.activeTripId = v.id; window.pLoc = [v.data().lat, v.data().lng];
                    document.getElementById('clientName').innerText = v.data().pasajeroNombre;
                    document.getElementById('tripAlert').style.display = 'block';
                    hablarIA(`Atención, ${loggedUserName}. Nueva solicitud detectada de ${v.data().pasajeroNombre}.`);
                }
            });
        });
    }

    window.toggleWork = () => {
        const isOff = document.getElementById('statusToggle').classList.toggle('off');
        document.getElementById('statusToggle').innerText = isOff ? "OFF" : "ON";
        document.getElementById('statusToggle').classList.toggle('on', !isOff);
        
        if(!isOff) {
            hablarIA(`Radar activado en el sistema virtual. Estás en línea.`);
            navigator.geolocation.watchPosition(p => {
                const c = [p.coords.latitude, p.coords.longitude];
                if(lastPos) {
                    const lat1 = lastPos[0]*Math.PI/180, lat2 = c[0]*Math.PI/180;
                    const dLon = (c[1]-lastPos[1])*Math.PI/180;
                    const h = (Math.atan2(Math.sin(dLon)*Math.cos(lat2), Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon))*180/Math.PI+360)%360;
                    document.getElementById('miniMap').style.transform = `rotateX(45deg) rotateZ(${-h}deg)`;
                }
                myMarker.setLatLng(c); miniMap.setView(c, 19); lastPos = c;
                const pInfo = JSON.parse(localStorage.getItem('driverProfile')) || {};
                setDoc(doc(db, "activos", auth.currentUser.uid), { nombre: loggedUserName, ...pInfo, lat: c[0], lng: c[1], online: true, busy: inTrip });
            });
        } else { updateDoc(doc(db, "activos", auth.currentUser.uid), { online: false }); }
    };

    window.respondTrip = async (status) => {
        if(status === 'aceptado') {
            inTrip = true;
            await updateDoc(doc(db, "viajes", window.activeTripId), { status: 'aceptado' });
            document.getElementById('tripAlert').style.display = 'none';
            document.getElementById('driverUI').style.display = 'flex';
            hablarIA("Viaje aceptado. Iniciando navegación asistida.");
            if(routingControl) miniMap.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [L.latLng(lastPos[0], lastPos[1]), L.latLng(window.pLoc[0], window.pLoc[1])],
                createMarker: () => null
            }).addTo(miniMap);
        } else {
            await updateDoc(doc(db, "viajes", window.activeTripId), { status: 'rechazado' });
            document.getElementById('tripAlert').style.display = 'none';
        }
    };

    window.finishTrip = async () => {
        hablarIA("Servicio finalizado con éxito.");
        await updateDoc(doc(db, "viajes", window.activeTripId), { status: 'finalizado' });
        setTimeout(() => location.reload(), 2000);
    };

    window.quickLogout = () => { auth.signOut(); location.reload(); };
</script>
</body>
</html>
