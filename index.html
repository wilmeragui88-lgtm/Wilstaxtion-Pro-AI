<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAXITON PRO | Wilmer Session</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --p: #3b82f6; --s: #22c55e; --d: #0f172a; --bg: #f8fafc; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body, html { height: 100%; background: var(--bg); overflow: hidden; }

        #map { position: absolute; top: 0; width: 100%; height: 40%; z-index: 1; border-bottom: 2px solid #ddd; }
        
        .panel { 
            position: absolute; bottom: 0; width: 100%; height: 60%; 
            background: white; border-radius: 30px 30px 0 0; padding: 20px; 
            z-index: 100; box-shadow: 0 -10px 25px rgba(0,0,0,0.1); overflow-y: auto;
        }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 15px; font-weight: 700; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        
        .overlay { position: fixed; inset: 0; background: var(--d); z-index: 9999; display: flex; flex-direction: column; padding: 30px; color: white; overflow-y: auto; }
        .hidden { display: none !important; }
        
        input { background: #1e293b; border: 1px solid #334155; padding: 14px; border-radius: 12px; color: white; margin-bottom: 12px; width: 100%; font-size: 14px; }
        
        .toggle-link { color: var(--p); text-align: center; margin-top: 15px; cursor: pointer; font-size: 14px; text-decoration: underline; }
        
        .profile-card { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .profile-img { width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 3px solid var(--p); }

        /* Pantalla de Carga Inicial */
        #splash { background: var(--d); display: flex; align-items: center; justify-content: center; z-index: 10000; position: fixed; inset: 0; }
    </style>
</head>
<body>

<div id="splash" class="overlay">
    <h2 style="color:var(--p)">TAXITON PRO</h2>
    <p>Verificando cuenta...</p>
</div>

<div id="registerScreen" class="overlay hidden">
    <h2 style="text-align:center; margin-bottom:10px;">CREAR PERFIL</h2>
    <input type="text" id="regName" placeholder="Nombre completo">
    <input type="text" id="regCar" placeholder="Vehículo (Ej: Kia Rio 2023)">
    <input type="email" id="regEmail" placeholder="Correo electrónico">
    <input type="password" id="regPass" placeholder="Contraseña">
    <button class="btn btn-s" onclick="handleRegister()">REGISTRARME</button>
    <p class="toggle-link" onclick="switchView('login')">¿Ya tienes cuenta? Inicia sesión</p>
</div>

<div id="loginScreen" class="overlay hidden">
    <h2 style="text-align:center; margin-bottom:10px;">INICIAR SESIÓN</h2>
    <input type="email" id="logEmail" placeholder="Correo electrónico">
    <input type="password" id="logPass" placeholder="Contraseña">
    <button class="btn btn-p" onclick="handleLogin()">ENTRAR</button>
    <p class="toggle-link" onclick="switchView('register')">Crear una cuenta nueva</p>
</div>

<div id="map"></div>

<div class="panel">
    <div class="profile-card">
        <img src="https://via.placeholder.com/150" id="driverImg" class="profile-img">
        <div style="flex:1">
            <b id="driverTitle">Nombre</b><br>
            <small id="driverCar" style="color:var(--p)"></small>
        </div>
        <button class="btn" style="width:auto; padding:8px 12px; font-size:12px;" onclick="handleLogout()">CERRAR SESIÓN</button>
    </div>
    <div id="mainUI">
        <div style="text-align:center; padding:20px; color:#94a3b8;">
            <p>Estado: <b>Conectado y Visible</b></p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCw7WoC5AjqnZ2_vagJs5ZklOZt3b4ZRtg",
        authDomain: "taxiton-eba22.firebaseapp.com",
        projectId: "taxiton-eba22",
        storageBucket: "taxiton-eba22.appspot.com",
        messagingSenderId: "1091576841981",
        appId: "1:1091576841981:web:1dd7bbefb518580fb76094"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // CONFIGURAR PERSISTENCIA LOCAL (Para recordar al usuario)
    setPersistence(auth, browserLocalPersistence);

    let map, userLoc;

    // MONITOR DE SESIÓN: Revisa si hay alguien logueado al abrir la app
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const d = await getDoc(doc(db, "users", user.uid));
            if (d.exists()) {
                startDriverApp(d.data());
            } else {
                switchView('register');
            }
        } else {
            document.getElementById('splash').classList.add('hidden');
            switchView('login');
        }
    });

    window.switchView = (view) => {
        document.getElementById('splash').classList.add('hidden');
        if(view === 'login') {
            document.getElementById('registerScreen').classList.remove('hidden');
            document.getElementById('loginScreen').classList.remove('hidden'); // Ajuste visual
            document.getElementById('registerScreen').classList.add('hidden');
        } else {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
        }
    };

    window.handleRegister = async () => {
        const email = document.getElementById('regEmail').value;
        const pass = document.getElementById('regPass').value;
        const name = document.getElementById('regName').value;
        try {
            const userCred = await createUserWithEmailAndPassword(auth, email, pass);
            const driverData = { name, car: document.getElementById('regCar').value, role: 'driver' };
            await setDoc(doc(db, "users", userCred.user.uid), driverData);
            // El onAuthStateChanged se encargará del resto
        } catch (e) { alert("Error: " + e.message); }
    };

    window.handleLogin = async () => {
        const email = document.getElementById('logEmail').value;
        const pass = document.getElementById('logPass').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (e) { alert("Credenciales incorrectas"); }
    };

    window.handleLogout = async () => {
        await signOut(auth);
        location.reload();
    };

    function startDriverApp(data) {
        document.getElementById('splash').classList.add('hidden');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('registerScreen').classList.add('hidden');
        
        document.getElementById('driverTitle').innerText = data.name;
        document.getElementById('driverCar').innerText = data.car;

        navigator.geolocation.getCurrentPosition(pos => {
            userLoc = [pos.coords.latitude, pos.coords.longitude];
            initMap(userLoc);
            setDoc(doc(db, "taxis", auth.currentUser.uid), {
                name: data.name, car: data.car, lat: userLoc[0], lng: userLoc[1], status: 'online'
            }, {merge: true});
        });
    }

    function initMap(coords) {
        if(!map) {
            map = L.map('map', { zoomControl: false }).setView(coords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker(coords).addTo(map);
            setTimeout(() => map.invalidateSize(), 800);
        }
    }
</script>
</body>
</html>
